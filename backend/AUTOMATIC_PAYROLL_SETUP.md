# Настройка автоматической отправки зарплат

## Как это работает

Система автоматически отправляет зарплаты работникам по расписанию, которое указывает CEO на сайте.

### Процесс работы:

1. **CEO устанавливает расписание** на странице `/constructor`:
   - `payroll_date` - дата отправки (например, `2024-12-25`)
   - `payroll_time` - время отправки в формате `HH:MM` (например, `14:30`)

2. **Планировщик проверяет расписание** каждую минуту (в 00 секунд)

3. **Когда наступает время**, система:
   - Проверяет баланс кошелька CEO
   - Вычисляет общую сумму зарплат всех активных работников
   - Если баланс достаточен, отправляет транзакции через Circle API
   - Сохраняет все транзакции в базу данных с статусом

## Требования для работы

### 1. Настройка компании (CEO)

На странице `/constructor` необходимо указать:

- **Wallet ID** (Circle Wallet ID) - ID кошелька компании в Circle
- **Payroll Date** - дата отправки зарплат (формат: `YYYY-MM-DD`)
- **Payroll Time** - время отправки (формат: `HH:MM`, 24-часовой формат)

Пример:
- Payroll Date: `2024-12-25`
- Payroll Time: `14:30` (2:30 PM)

### 2. Настройка работников

Каждый работник должен иметь:
- **Wallet Address** - адрес кошелька для получения зарплаты (формат: `0x...`)
- **Salary** - зарплата в USDC
- **Is Active** - должен быть активным

### 3. Настройка .env файла

В `backend/.env` должны быть установлены:

```env
# Circle API
CIRCLE_API_KEY=your_circle_api_key
CIRCLE_BASE_URL=https://api.circle.com/v1

# Entity Secret (обязательно!)
ENTITY_SECRET=your_64_character_hex_secret

# USDC Token ID (опционально - будет найден автоматически)
USDC_TOKEN_ID=15dc2b5d-0994-58b0-bf8c-3a0501148ee8
```

### 4. Запуск сервера

Сервер должен быть запущен для работы планировщика:

```bash
cd backend
python main.py
```

Планировщик запускается автоматически при старте сервера.

## Как проверить работу

### 1. Проверка логов

При запуске сервера вы увидите:
```
[APP] Payroll scheduler started - checking every minute
```

Каждую минуту планировщик проверяет расписание:
```
[PAYROLL SCHEDULER] check_and_execute_payrolls() called
[PAYROLL SCHEDULER] Checking all companies for scheduled payrolls...
```

### 2. Когда наступает время

Вы увидите подробные логи:
```
[PAYROLL SCHEDULER] execute_scheduled_payroll() called
[PAYROLL SCHEDULER] Company ID: 1
[PAYROLL SCHEDULER] Wallet ID: a35494a6-3d52-5eeb-8b42-b3bb5ec9a4d7
[PAYROLL SCHEDULER] Found 3 active worker(s)
[PAYROLL SCHEDULER] Checking wallet ID balance...
[PAYROLL SCHEDULER] Wallet Balance: 100.0 USDC
[PAYROLL SCHEDULER] Total Payroll Required: 50.0 USDC
[PAYROLL SCHEDULER] Balance sufficient ✓
[PAYROLL SCHEDULER] Starting payroll execution...
[PAYROLL SCHEDULER] Processing worker 1/3: John Doe
[PAYROLL SCHEDULER] Transaction created successfully!
[PAYROLL SCHEDULER]   Transaction ID: 2a939f78-7052-5e11-987f-96608490be28
[PAYROLL SCHEDULER]   State: INITIATED
```

### 3. Проверка транзакций в базе данных

Все транзакции сохраняются в таблицу `payroll_transactions` с полями:
- `circle_transaction_id` - ID транзакции в Circle
- `status` - статус транзакции (INITIATED, QUEUED, SENT, CONFIRMED, COMPLETE, FAILED)
- `transaction_hash` - хеш транзакции в блокчейне (если доступен)

## Важные моменты

### Защита от дублирования

Система проверяет, не была ли уже отправлена зарплата сегодня для данного периода. Это предотвращает повторную отправку.

### Проверка баланса

Перед отправкой система проверяет баланс кошелька. Если баланс недостаточен, транзакции не выполняются.

### Обработка ошибок

Если транзакция не удалась для одного работника, система продолжит обработку остальных работников. Статус `failed` будет сохранен в базе данных.

### Точность времени

Планировщик проверяет время с точностью до минуты. Транзакции выполняются в течение минуты, когда наступает указанное время.

## Примеры использования

### Ежедневная отправка

Установите `payroll_date` на сегодняшнюю дату и `payroll_time` на нужное время. После выполнения обновите `payroll_date` на следующую дату.

### Ежемесячная отправка

Установите `payroll_date` на дату следующей отправки (например, 1-го числа месяца) и `payroll_time` на нужное время.

### Тестирование

Для тестирования установите `payroll_date` на сегодня и `payroll_time` на время через несколько минут. Следите за логами сервера.

## Устранение проблем

### Планировщик не запускается

- Убедитесь, что сервер запущен
- Проверьте логи на наличие ошибок
- Убедитесь, что `apscheduler` установлен: `pip install apscheduler`

### Транзакции не выполняются

- Проверьте, что `ENTITY_SECRET` установлен в `.env`
- Проверьте, что `CIRCLE_API_KEY` правильный
- Проверьте баланс кошелька
- Проверьте, что у работников указаны правильные адреса кошельков

### Неправильное время выполнения

- Убедитесь, что время указано в формате `HH:MM` (24-часовой формат)
- Проверьте часовой пояс сервера
- Планировщик проверяет время каждую минуту, поэтому транзакция может выполниться в течение минуты после указанного времени


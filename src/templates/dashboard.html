<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARC budget - Dashboard</title>
    <link rel="stylesheet" href="/static/futuristic.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>ARC budget Dashboard</h1>
            <nav>
                <a href="/constructor" class="nav-link">Constructor</a>
                <a href="/login" class="nav-link">Logout</a>
            </nav>
        </header>
        
        <main class="dashboard-main">
            <div class="dashboard-layout">
                <!-- Main Content: Pie Chart and Expenses Chart -->
                <div class="dashboard-main-content">
                    <div class="card">
                        <h2 class="card-title">Department Costs</h2>
                        <div class="donut-chart-wrapper">
                            <div class="donut-chart-container">
                                <canvas id="departmentChart"></canvas>
                            </div>
                            <div class="donut-chart-legend" id="departmentLegend">
                                <!-- Legend will be generated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="chart-header">
                            <h2 class="card-title">Expenses by Month</h2>
                            <div class="date-picker-container">
                                <label for="startMonth">From:</label>
                                <input type="month" id="startMonth" class="date-input">
                                <label for="endMonth">To:</label>
                                <input type="month" id="endMonth" class="date-input">
                                <button id="updateChart" class="btn btn-primary btn-small">Update</button>
                            </div>
                        </div>
                        <div class="chart-container chart-container-compact">
                            <canvas id="expensesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Stats Grid, Revenues and Expenses -->
                <div class="dashboard-right-panel">
                    <div class="stats-grid">
                        <div class="stat-card" data-icon="workers">
                            <div class="stat-label">Total Workers</div>
                            <div class="stat-value">{{ total_workers }}</div>
                        </div>
                        <div class="stat-card" data-icon="departments">
                            <div class="stat-label">Total Departments</div>
                            <div class="stat-value">{{ total_departments }}</div>
                        </div>
                        <div class="stat-card" data-icon="revenue">
                            <div class="stat-label">Total Revenue</div>
                            <div class="stat-value positive">${{ "%.2f"|format(total_revenue) }}</div>
                        </div>
                        <div class="stat-card" data-icon="expenses">
                            <div class="stat-label">Total Expenses</div>
                            <div class="stat-value negative">${{ "%.2f"|format(total_expenses) }}</div>
                        </div>
                        <div class="stat-card" data-icon="profit">
                            <div class="stat-label">Profit</div>
                            <div class="stat-value {% if profit >= 0 %}positive{% else %}negative{% endif %}">${{ "%.2f"|format(profit) }}</div>
                        </div>
                        {% if ceo_data %}
                        <div class="stat-card" data-icon="wallet">
                            <div class="stat-label">Master Wallet</div>
                            <div class="stat-value" style="font-size: 0.9rem; font-family: monospace;">{{ ceo_data.get('master_wallet', '')[:10] }}...{{ ceo_data.get('master_wallet', '')[-8:] }}</div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="card">
                        <div class="expenses-header">
                            <h2 class="card-title">Transaction history</h2>
                            <div class="expenses-search-container">
                                <div class="expenses-search">
                                    <svg class="search-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M7.33333 12.6667C10.2789 12.6667 12.6667 10.2789 12.6667 7.33333C12.6667 4.38781 10.2789 2 7.33333 2C4.38781 2 2 4.38781 2 7.33333C2 10.2789 4.38781 12.6667 7.33333 12.6667Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M14 14L11.1 11.1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <input type="text" id="expensesSearch" placeholder="Transaction ID, hash, ref ID" class="expenses-search-input">
                                    <div class="search-divider"></div>
                                    <span class="search-shortcut">/</span>
                                </div>
                            </div>
                        </div>
                        <div class="expenses-table-container">
                            {% if circle_transactions %}
                            <table class="expenses-table">
                                <thead>
                                    <tr>
                                        <th>
                                            Transaction ID
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M8 12L4 8L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </th>
                                        <th>
                                            Reference ID
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M8 12L4 8L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </th>
                                        <th>
                                            Date
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M8 12L4 8L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </th>
                                        <th>
                                            Amount
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M8 12L4 8L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tx in circle_transactions %}
                                    <tr class="expense-row" style="cursor: pointer;">
                                        <td class="expense-transaction-id">
                                            {% set tx_id = tx.get('transaction_id', 'N/A') %}
                                            {% if tx_id|length > 14 %}
                                                {{ tx_id[:7] }}...{{ tx_id[-6:] }}
                                            {% else %}
                                                {{ tx_id }}
                                            {% endif %}
                                        </td>
                                        <td class="expense-reference-id">
                                            {% set ref_id = tx.get('reference_id', 'N/A') %}
                                            {% if ref_id|length > 12 %}
                                                {{ ref_id[:6] }}...{{ ref_id[-6:] }}
                                            {% else %}
                                                {{ ref_id }}
                                            {% endif %}
                                        </td>
                                        <td class="expense-date">{{ tx.get('date', 'N/A') }}</td>
                                        <td class="expense-amount" style="color: {% if tx.get('is_incoming', False) %}#10b981{% else %}#ef4444{% endif %}; font-weight: 500;">
                                            {% if tx.get('is_incoming', False) %}+{% else %}-{% endif %} {{ tx.get('amount_formatted', tx.get('amount', 0)) }} {{ tx.get('currency', 'USDC') }}
                                        </td>
                                        <td class="expense-arrow">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% elif expenses_list %}
                            <table class="expenses-table">
                                <thead>
                                    <tr>
                                        <th>
                                            Transaction ID
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M8 12L4 8L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </th>
                                        <th>
                                            Reference ID
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M8 12L4 8L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </th>
                                        <th>
                                            Date
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M8 12L4 8L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </th>
                                        <th>
                                            Amount
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M8 12L4 8L8 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for expense in expenses_list %}
                                    <tr class="expense-row" onclick="openEditExpenseModal({{ loop.index0 }})" style="cursor: pointer;">
                                        <td class="expense-transaction-id">{{ expense.get('name', 'N/A')[:8] }}...{{ expense.get('name', 'N/A')[-6:] if expense.get('name', 'N/A')|length > 14 else expense.get('name', 'N/A') }}</td>
                                        <td class="expense-reference-id">{{ expense.get('type', '')[:6] }}...{{ expense.get('type', '')[-6:] if expense.get('type', '')|length > 12 else expense.get('type', '') }}</td>
                                        <td class="expense-date" id="expense-date-{{ loop.index0 }}">{{ expense.get('date', 'N/A') }}</td>
                                        <td class="expense-amount negative">${{ "%.2f"|format(expense.get('amount', 0)) }}</td>
                                        <td class="expense-arrow">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                                <div class="empty-state">No transactions recorded</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Prepare data for pie chart with detailed info
        const deptData = [
            {% for dept in dept_stats %}
            {
                name: "{{ dept.get('name', '') }}",
                total: {{ dept.get('total', 0) }},
                worker_count: {{ dept.get('worker_count', 0) }},
                payroll: {{ dept.get('payroll', 0) }},
                spendings: {{ dept.get('spendings', 0) }},
                workers: [
                    {% for worker in dept.get('workers', []) %}
                    {
                        name: "{{ worker.get('name', '') }} {{ worker.get('surname', '') }}",
                        salary: {{ worker.get('salary', 0) }}
                    }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ]
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        // Calculate total for percentages
        const totalCost = deptData.reduce((sum, dept) => sum + dept.total, 0);
        
        // Colors matching Nexo style
        const chartColors = [
            '#F97316',  // Orange
            '#3B82F6',  // Blue
            '#10B981',  // Green
            '#06B6D4',  // Teal
            '#7C3AED',  // Purple
            '#F59E0B',  // Amber
            '#EF4444',  // Red
            '#8B5CF6'   // Purple Light
        ];
        
        const ctx = document.getElementById('departmentChart');
        const legendContainer = document.getElementById('departmentLegend');
        
        // Check if Chart.js is loaded
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded!');
            if (legendContainer) {
                legendContainer.innerHTML = '<div style="color: #ef4444; padding: 1rem;">Error: Chart.js library not loaded. Please check your internet connection.</div>';
            }
        } else if (ctx) {
            if (deptData.length > 0 && totalCost > 0) {
                // Create chart with data
                const chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: deptData.map(d => d.name),
                        datasets: [{
                            data: deptData.map(d => d.total),
                            backgroundColor: chartColors.slice(0, deptData.length),
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#111827',
                                bodyColor: '#6B7280',
                                borderColor: 'rgba(59, 130, 246, 0.3)',
                                borderWidth: 1,
                                padding: 12,
                                titleFont: {
                                    size: 14,
                                    weight: 'bold',
                                    family: "'Inter', sans-serif"
                                },
                                bodyFont: {
                                    size: 12,
                                    family: "'Inter', sans-serif"
                                },
                                callbacks: {
                                    label: function(context) {
                                        const dept = deptData[context.dataIndex];
                                        const percentage = ((dept.total / totalCost) * 100).toFixed(1);
                                        return dept.name + ': $' + dept.total.toFixed(2) + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Generate custom legend
                if (legendContainer) {
                    legendContainer.innerHTML = '';
                    deptData.forEach((dept, index) => {
                        const percentage = ((dept.total / totalCost) * 100).toFixed(1);
                        const legendItem = document.createElement('div');
                        legendItem.className = 'legend-item';
                        legendItem.innerHTML = `
                            <div class="legend-color" style="background-color: ${chartColors[index]}"></div>
                            <div class="legend-content">
                                <div class="legend-name">${dept.name}</div>
                                <div class="legend-details">
                                    <span class="legend-amount">$${dept.total.toFixed(2)}</span>
                                    <span class="legend-percentage">${percentage}%</span>
                                </div>
                            </div>
                        `;
                        legendContainer.appendChild(legendItem);
                    });
                }
            } else {
                // No data - show message
                console.log('No department data available for chart');
                if (legendContainer) {
                    legendContainer.innerHTML = '<div style="color: #64748b; padding: 1rem; text-align: center;">No departments found. Please add departments and workers in the Constructor page.</div>';
                }
                // Draw empty chart or hide canvas
                if (ctx) {
                    ctx.style.display = 'none';
                }
            }
        } else {
            console.error('Canvas element #departmentChart not found!');
        }

        // Prepare expenses data for chart (will be synced with modal data later)
        let chartExpensesData = [
            {% for expense in expenses_list %}
            {
                date: "{{ expense.get('date', '') }}",
                amount: {{ expense.get('amount', 0) }},
                name: "{{ expense.get('name', '') }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        // Make expensesData available globally for chart updates (create early)
        window.expensesDataForChart = chartExpensesData.map(e => ({
            date: e.date,
            amount: e.amount,
            name: e.name
        }));
        
        // Expenses by Month Chart
        const expensesCtx = document.getElementById('expensesChart');
        let expensesChart = null;
        
        // Function to update chart with current expenses data (make it global)
        window.updateExpensesChart = function(chartData) {
            if (!expensesChart) return;
            
            const startMonth = document.getElementById('startMonth')?.value;
            const endMonth = document.getElementById('endMonth')?.value;
            
            // Group expenses by month
            const expensesByMonth = {};
            chartData.forEach((expense) => {
                let monthKey = 'Unknown';
                if (expense.date) {
                    const dateParts = expense.date.split('-');
                    if (dateParts.length >= 2) {
                        monthKey = `${dateParts[0]}-${dateParts[1]}`;
                    }
                } else {
                    const now = new Date();
                    monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                }
                
                // Filter by date range if specified
                if (startMonth && endMonth) {
                    if (monthKey < startMonth || monthKey > endMonth) {
                        return; // Skip this expense if outside range
                    }
                }
                
                if (!expensesByMonth[monthKey]) {
                    expensesByMonth[monthKey] = 0;
                }
                expensesByMonth[monthKey] += expense.amount;
            });
            
            // Format month labels
            const formatMonth = (monthStr) => {
                const [year, month] = monthStr.split('-');
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            };
            
            const months = Object.keys(expensesByMonth).sort();
            const amounts = months.map(month => expensesByMonth[month]);
            const monthLabels = months.map(formatMonth);
            
            expensesChart.data.labels = monthLabels.length > 0 ? monthLabels : ['No data in range'];
            expensesChart.data.datasets[0].data = amounts.length > 0 ? amounts : [0];
            expensesChart.update();
        }
        
        if (expensesCtx) {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded for expenses chart!');
                expensesCtx.parentElement.innerHTML = '<div style="color: #ef4444; padding: 2rem; text-align: center;">Error: Chart.js library not loaded. Please check your internet connection.</div>';
            } else {
                // Use global expensesDataForChart if available, otherwise use chartExpensesData
                const dataToUse = window.expensesDataForChart || chartExpensesData;

                // Create chart first with empty data
                expensesChart = new Chart(expensesCtx, {
                type: 'line',
                data: {
                    labels: ['No data'],
                    datasets: [{
                        label: 'Monthly Expenses',
                        data: [0],
                        borderColor: 'rgba(245, 158, 11, 1)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: 'rgba(245, 158, 11, 1)',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 12,
                                    family: "'Inter', sans-serif"
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1e293b',
                            bodyColor: '#64748b',
                            borderColor: 'rgba(245, 158, 11, 0.3)',
                            borderWidth: 2,
                            padding: 15,
                            callbacks: {
                                label: function(context) {
                                    return 'Expenses: $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                },
                                font: {
                                    family: "'Inter', sans-serif"
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: "'Inter', sans-serif"
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
            
                // Initialize chart with current data after chart is created
                if (typeof window.updateExpensesChart === 'function') {
                    window.updateExpensesChart(dataToUse);
                }

                // Date picker functionality
                document.getElementById('updateChart').addEventListener('click', function() {
                const startMonth = document.getElementById('startMonth').value;
                const endMonth = document.getElementById('endMonth').value;
                
                if (startMonth && endMonth) {
                    // Get current expenses data (from global expensesDataForChart)
                    const currentData = window.expensesDataForChart || dataToUse;
                    if (typeof window.updateExpensesChart === 'function') {
                        window.updateExpensesChart(currentData);
                    }
                } else {
                    alert('Please select both start and end months');
                }
                });

                // Set default months (last 6 months)
                const today = new Date();
                const sixMonthsAgo = new Date(today);
                sixMonthsAgo.setMonth(today.getMonth() - 6);
                
                const formatMonthInput = (date) => {
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                };
                
                document.getElementById('endMonth').value = formatMonthInput(today);
                document.getElementById('startMonth').value = formatMonthInput(sixMonthsAgo);
            }
        }
                
                // Align bottom borders: pie chart card with Master Wallet card
                function alignBottomBorders() {
                    const pieChartCard = document.querySelector('.dashboard-main-content .card:first-child');
                    const statsGrid = document.querySelector('.dashboard-right-panel .stats-grid');
                    
                    if (pieChartCard && statsGrid) {
                        const statsGridHeight = statsGrid.offsetHeight;
                        pieChartCard.style.minHeight = statsGridHeight + 'px';
                    }
                }
                
                // Align Expenses card bottom border with Expenses by Month card
                function alignExpensesBorders() {
                    const expensesByMonthCard = document.querySelector('.dashboard-main-content .card:nth-child(2)');
                    const expensesCard = document.querySelector('.dashboard-right-panel .card');
                    
                    if (expensesByMonthCard && expensesCard) {
                        const expensesByMonthHeight = expensesByMonthCard.offsetHeight;
                        expensesCard.style.minHeight = expensesByMonthHeight + 'px';
                    }
                }
                
                // Align on load and resize
                window.addEventListener('load', function() {
                    setTimeout(function() {
                        alignBottomBorders();
                        alignExpensesBorders();
                    }, 100);
                });
                window.addEventListener('resize', function() {
                    alignBottomBorders();
                    alignExpensesBorders();
                });
                
                // Edit Expense Modal - this is the main expenses data array
                const expensesData = [
                    {% for expense in expenses_list %}
                    {
                        name: "{{ expense.get('name', 'N/A') }}",
                        type: "{{ expense.get('type', '') }}",
                        amount: {{ expense.get('amount', 0) }},
                        date: "{{ expense.get('date', '') }}",
                        expense_id: {{ expense.get('expense_id', -1) }},
                        expense_type: "{{ expense.get('expense_type', '') }}"
                    }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ];
                
                // Update global expensesDataForChart with modal expensesData (sync dates)
                expensesData.forEach((expense, index) => {
                    if (window.expensesDataForChart && window.expensesDataForChart[index]) {
                        window.expensesDataForChart[index].date = expense.date;
                        window.expensesDataForChart[index].amount = expense.amount;
                        window.expensesDataForChart[index].name = expense.name;
                    }
                });
                
                function openEditExpenseModal(index) {
                    const expense = expensesData[index];
                    if (!expense) return;
                    
                    const modal = document.getElementById('editExpenseModal');
                    const backdrop = document.getElementById('editExpenseModalBackdrop');
                    
                    if (!modal || !backdrop) return;
                    
                    // Set form values
                    document.getElementById('editExpenseName').textContent = expense.name;
                    document.getElementById('editExpenseType').textContent = expense.type;
                    document.getElementById('editExpenseAmount').textContent = '$' + expense.amount.toFixed(2);
                    document.getElementById('editExpenseDate').value = expense.date || '';
                    document.getElementById('editExpenseIndex').value = index;
                    
                    // Show modal
                    backdrop.style.display = 'flex';
                    modal.style.display = 'block';
                    setTimeout(() => {
                        backdrop.classList.add('active');
                        modal.classList.add('active');
                    }, 10);
                }
                
                function closeEditExpenseModal() {
                    const modal = document.getElementById('editExpenseModal');
                    const backdrop = document.getElementById('editExpenseModalBackdrop');
                    
                    if (!modal || !backdrop) return;
                    
                    backdrop.classList.remove('active');
                    modal.classList.remove('active');
                    
                    setTimeout(() => {
                        backdrop.style.display = 'none';
                        modal.style.display = 'none';
                    }, 300);
                }
                
                async function saveExpenseDate() {
                    const index = parseInt(document.getElementById('editExpenseIndex').value);
                    const newDate = document.getElementById('editExpenseDate').value;
                    
                    if (index >= 0 && expensesData[index]) {
                        const expense = expensesData[index];
                        expense.date = newDate;
                        
                        // Update the date in the UI
                        const dateElement = document.getElementById('expense-date-' + index);
                        if (dateElement) {
                            dateElement.textContent = newDate;
                        }
                        
                        // Update chart data
                        if (window.expensesDataForChart && window.expensesDataForChart[index]) {
                            window.expensesDataForChart[index].date = newDate;
                        }
                        
                        // Update chart immediately with updated data
                        if (typeof window.updateExpensesChart === 'function' && window.expensesDataForChart) {
                            window.updateExpensesChart(window.expensesDataForChart);
                        }
                        
                        // Save to backend if it's a spending
                        if (expense.expense_type === 'spending' && expense.expense_id > 0) {
                            try {
                                const response = await fetch('/api/expenses/update-date', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        expense_id: expense.expense_id,
                                        expense_type: expense.expense_type,
                                        date: newDate
                                    })
                                });
                                
                                if (!response.ok) {
                                    console.error('Failed to save date to backend');
                                }
                            } catch (error) {
                                console.error('Error saving date:', error);
                            }
                        }
                    }
                    
                    closeEditExpenseModal();
                }
                
                // Search functionality
                const expensesSearchInput = document.getElementById('expensesSearch');
                if (expensesSearchInput) {
                    expensesSearchInput.addEventListener('input', function(e) {
                        const searchTerm = e.target.value.toLowerCase();
                        const rows = document.querySelectorAll('.expense-row');
                        
                        rows.forEach(row => {
                            const transactionId = row.querySelector('.expense-transaction-id')?.textContent.toLowerCase() || '';
                            const referenceId = row.querySelector('.expense-reference-id')?.textContent.toLowerCase() || '';
                            const date = row.querySelector('.expense-date')?.textContent.toLowerCase() || '';
                            const amount = row.querySelector('.expense-amount')?.textContent.toLowerCase() || '';
                            
                            const matches = transactionId.includes(searchTerm) || 
                                           referenceId.includes(searchTerm) || 
                                           date.includes(searchTerm) || 
                                           amount.includes(searchTerm);
                            
                            row.style.display = matches ? '' : 'none';
                        });
                    });
                    
                    // Keyboard shortcut for search (press / to focus)
                    document.addEventListener('keydown', function(e) {
                        if (e.key === '/' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                            e.preventDefault();
                            expensesSearchInput.focus();
                        }
                    });
                }
                
                // Setup event listeners
                document.addEventListener('DOMContentLoaded', function() {
                    const backdrop = document.getElementById('editExpenseModalBackdrop');
                    const modal = document.getElementById('editExpenseModal');
                    
                    if (backdrop) {
                        backdrop.addEventListener('click', function(e) {
                            if (e.target === backdrop) {
                                closeEditExpenseModal();
                            }
                        });
                    }
                    
                    if (modal) {
                        modal.addEventListener('click', function(e) {
                            e.stopPropagation();
                        });
                    }
                });
            </script>
            
            <!-- Edit Expense Modal -->
            <div class="edit-expense-modal-backdrop" id="editExpenseModalBackdrop"></div>
            <div class="edit-expense-modal" id="editExpenseModal">
                <div class="edit-expense-modal-content">
                    <h3 class="modal-title">Edit Expense</h3>
                    <div class="modal-form">
                        <div class="modal-form-group">
                            <label>Name:</label>
                            <div class="modal-form-value" id="editExpenseName">-</div>
                        </div>
                        <div class="modal-form-group">
                            <label>Type:</label>
                            <div class="modal-form-value" id="editExpenseType">-</div>
                        </div>
                        <div class="modal-form-group">
                            <label>Amount:</label>
                            <div class="modal-form-value" id="editExpenseAmount">-</div>
                        </div>
                        <div class="modal-form-group">
                            <label for="editExpenseDate">Date:</label>
                            <input type="date" id="editExpenseDate" class="modal-form-input" required>
                        </div>
                        <input type="hidden" id="editExpenseIndex" value="-1">
                        <div class="modal-form-actions">
                            <button type="button" class="btn btn-primary" onclick="saveExpenseDate()">Save</button>
                            <button type="button" class="btn btn-secondary" onclick="closeEditExpenseModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
</body>
</html>
